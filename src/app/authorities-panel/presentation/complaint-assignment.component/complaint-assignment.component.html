<div class="team-management-container">
  <div class="header-section">
    <h2>{{ 'TEAM_MANAGEMENT.TITLE' | translate }}</h2>
    <p>{{ 'TEAM_MANAGEMENT.SUBTITLE' | translate }}</p>
  </div>

  <div class="stats-grid">
  </div>

  <div class="toolbar">
    <button mat-raised-button color="primary" (click)="reloadData()" [disabled]="loading()">
      <mat-icon>refresh</mat-icon>
      <span class="button-text">{{ 'TEAM_MANAGEMENT.ACTIONS.REFRESH_DATA' | translate }}</span>
    </button>

    <button mat-button color="warn" (click)="clearFilters()">
      <mat-icon>clear_all</mat-icon>
      <span class="button-text">{{ 'TEAM_MANAGEMENT.ACTIONS.CLEAR_FILTERS' | translate }}</span>
    </button>

    <div class="spacer"></div>

    <button mat-raised-button color="accent" (click)="navigateToCreateResponsible()">
      <mat-icon>person_add</mat-icon>
      <span class="button-text">{{ 'TEAM_MANAGEMENT.ACTIONS.ADD_RESPONSIBLE' | translate }}</span>
    </button>
  </div>


  <div class="team-table">
    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ 'TEAM_MANAGEMENT.TABLE.TITLE' | translate }}</mat-card-title>
        <mat-card-subtitle>
          {{ 'TEAM_MANAGEMENT.TABLE.SUBTITLE' | translate: { count: teamMembersWithAssignments().length } }}
          <span *ngIf="departmentFilter()" class="filter-indicator">
            • {{ 'TEAM_MANAGEMENT.TABLE.DEPARTMENT_FILTER' | translate: { department: departmentFilter() } }}
          </span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="teamMembersWithAssignments()" class="mat-elevation-z1">

            <ng-container matColumnDef="teamMember">
              <th mat-header-cell *matHeaderCellDef>{{ 'TEAM_MANAGEMENT.TABLE.COLUMNS.TEAM_MEMBER' | translate }}</th>
              <td mat-cell *matCellDef="let member">
                <div class="member-info">
                  <div class="member-avatar">
                    <mat-icon>person</mat-icon>
                  </div>
                  <div class="member-details">
                    <strong>{{ member.firstName }} {{ member.lastName }}</strong>
                    <small>{{ member.position }} • {{ member.department }}</small>
                    <div class="contact-info">
                      <mat-icon class="contact-icon">email</mat-icon>
                      <span class="email-text">{{ member.email }}</span>
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef class="mobile-hidden">
                {{ 'TEAM_MANAGEMENT.TABLE.COLUMNS.STATUS' | translate }}
              </th>
              <td mat-cell *matCellDef="let member" class="mobile-hidden">
                <div class="status-indicator">
                  <mat-icon [class]="member.status">{{ getStatusIcon(member.status) }}</mat-icon>
                  <span [class]="member.status">{{ getStatusTranslation(member.status) | translate }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="workload">
              <th mat-header-cell *matHeaderCellDef>{{ 'TEAM_MANAGEMENT.TABLE.COLUMNS.WORKLOAD' | translate }}</th>
              <td mat-cell *matCellDef="let member">
                <div class="workload-container">
                  <mat-progress-bar
                    [value]="member.workload"
                    [color]="getWorkloadColor(member.workload)"
                    mode="determinate">
                  </mat-progress-bar>
                  <span class="workload-text">{{ member.workload.toFixed(0) }}%</span>
                </div>
                <small>{{ member.assignedComplaints.length }} {{ 'TEAM_MANAGEMENT.TABLE.MEMBERS.ASSIGNED_COMPLAINTS_COUNT' | translate }}</small>
              </td>
            </ng-container>

            <ng-container matColumnDef="assignedComplaints">
              <th mat-header-cell *matHeaderCellDef class="tablet-hidden">
                {{ 'TEAM_MANAGEMENT.TABLE.COLUMNS.ASSIGNED_COMPLAINTS' | translate }}
              </th>
              <td mat-cell *matCellDef="let member" class="tablet-hidden">
                <div class="complaints-list" *ngIf="member.assignedComplaints.length > 0; else noAssignedComplaints">
                  <div *ngFor="let complaintItem of member.assignedComplaints" class="complaint-item">
                    <div class="complaint-header">
                      <span class="complaint-id">#{{ complaintItem.id }}</span>
                      <mat-icon
                        [class]="complaintItem.priority"
                        [matTooltip]="complaintItem.priority | titlecase"
                        class="priority-icon">
                        {{ getPriorityIcon(complaintItem.priority) }}
                      </mat-icon>
                    </div>
                    <span class="complaint-title">{{ complaintItem.category }}</span>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="unassignComplaint(getAssignmentIdForComplaint(member, complaintItem.id))"
                      [disabled]="loading()"
                      class="unassign-btn"
                      [matTooltip]="'TEAM_MANAGEMENT.ACTIONS.UNASSIGN' | translate">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
                <ng-template #noAssignedComplaints>
                  <span class="no-complaints">{{ 'TEAM_MANAGEMENT.TABLE.MEMBERS.NO_ASSIGNED_COMPLAINTS' | translate }}</span>
                </ng-template>
              </td>
            </ng-container>

            <ng-container matColumnDef="availableComplaints">
              <th mat-header-cell *matHeaderCellDef>{{ 'TEAM_MANAGEMENT.TABLE.COLUMNS.ASSIGN_NEW_COMPLAINT' | translate }}</th>
              <td mat-cell *matCellDef="let member">
                <mat-form-field appearance="outline" class="complaint-select">
                  <mat-label>{{ 'TEAM_MANAGEMENT.TABLE.MEMBERS.SELECT_COMPLAINT' | translate }}</mat-label>
                  <mat-select
                    [value]="getSelectedComplaint(member.id) || ''"
                    (selectionChange)="onComplaintAssignment(member.id, $event.value)">
                    <mat-option value="">{{ 'TEAM_MANAGEMENT.TABLE.MEMBERS.NO_COMPLAINT_SELECTED' | translate }}</mat-option>
                    <mat-option
                      *ngFor="let complaintItem of member.availableComplaints"
                      [value]="complaintItem.id"
                      [disabled]="member.status === 'offline'">
                      <div class="complaint-option">
                        <span class="complaint-id">#{{ complaintItem.id }}</span>
                        <span class="complaint-priority" [class]="complaintItem.priority">
                          {{ complaintItem.priority }}
                        </span>
                        <span class="complaint-category">{{ complaintItem.category }}</span>
                      </div>
                    </mat-option>
                    <mat-option *ngIf="member.availableComplaints.length === 0" disabled>
                      {{ 'TEAM_MANAGEMENT.TABLE.MEMBERS.NO_AVAILABLE_COMPLAINTS' | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>{{ 'TEAM_MANAGEMENT.TABLE.COLUMNS.ACTIONS' | translate }}</th>
              <td mat-cell *matCellDef="let member">
                <button
                  mat-raised-button
                  color="primary"
                  (click)="assignComplaint(member.id)"
                  [disabled]="!hasPendingChanges(member.id) || loading() || member.status === 'offline'"
                  class="assign-btn">
                  <mat-icon>assignment</mat-icon>
                  <span class="button-text">{{ 'TEAM_MANAGEMENT.ACTIONS.ASSIGN_COMPLAINT' | translate }}</span>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="getDisplayedColumns()"></tr>
            <tr mat-row *matRowDef="let row; columns: getDisplayedColumns();"></tr>
          </table>
        </div>

        <div *ngIf="teamMembersWithAssignments().length === 0 && !loading()" class="empty-state">
          <mat-icon>group_off</mat-icon>
          <p>{{ 'TEAM_MANAGEMENT.TABLE.EMPTY_STATE.MESSAGE' | translate }}</p>
          <button mat-button color="primary" (click)="clearFilters()">
            {{ 'TEAM_MANAGEMENT.TABLE.EMPTY_STATE.ACTION' | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="loading()" class="loading-overlay">
    <mat-spinner diameter="40"></mat-spinner>
    <p>{{ 'TEAM_MANAGEMENT.TABLE.LOADING' | translate }}</p>
  </div>
</div>
