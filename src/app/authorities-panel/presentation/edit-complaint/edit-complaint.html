<div class="container">
  <button class="back-button" mat-stroked-button color="accent" routerLink="/complaint-list">
    ‚Üê {{ 'Back to Complaints' | translate }}
  </button>

  <h2>{{ 'Edit Complaint' | translate }} #{{ complaintId }}</h2>

  @if (isLoading) {
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>{{ 'Loading complaint data...' | translate }}</p>
    </div>
  } @else if (errorMessage) {
    <div class="error">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ errorMessage }}</p>
      <button mat-button (click)="loadComplaintData()">{{ 'Retry' | translate }}</button>
    </div>
  } @else {
    <form [formGroup]="complaintForm" class="edit-form">
      <div class="row">
        <mat-form-field appearance="fill" class="readonly">
          <mat-label>{{ 'Category' | translate }}</mat-label>
          <input matInput formControlName="category" readonly />
        </mat-form-field>

        <mat-form-field appearance="fill" class="readonly">
          <mat-label>{{ 'Location' | translate }}</mat-label>
          <input matInput formControlName="location" readonly />
        </mat-form-field>
      </div>

      <mat-form-field appearance="fill" class="full-width readonly">
        <mat-label>{{ 'Reference' | translate }}</mat-label>
        <input matInput formControlName="referenceInfo" /> <!-- Quitado readonly -->
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width readonly">
        <mat-label>{{ 'Description' | translate }}</mat-label>
        <textarea matInput formControlName="description" readonly></textarea>
      </mat-form-field>

      <div class="evidence-section">
        <h3>{{ 'Evidence' | translate }}</h3>

        @let evidence = complaintData?.evidence;

        @if (evidence && evidence.length > 0) {
          <div class="evidence-gallery">
            @for (img of evidence; track img) {
              <img
                [src]="img"
                alt="{{ 'Evidence' | translate }}"
                class="evidence-img"
                (click)="openImage(img)"
              />
            }
          </div>
        } @else {
          <p class="no-evidence">{{ 'No attached images' | translate }}</p>
        }
      </div>

      <div class="row">
        <mat-form-field appearance="fill">
          <mat-label>{{ 'Status' | translate }}</mat-label>
          <mat-select formControlName="status">
            @for (s of statuses; track s) {
              <mat-option [value]="s">{{ s | translate }}</mat-option>
            }
          </mat-select>
          @if (complaintForm.get('status')?.invalid && complaintForm.get('status')?.touched) {
            <mat-error>{{ 'Status is required' | translate }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>{{ 'Priority' | translate }}</mat-label>
          <mat-select formControlName="priority">
            @for (p of priorities; track p) {
              <mat-option [value]="p">{{ p | translate }}</mat-option>
            }
          </mat-select>
          @if (complaintForm.get('priority')?.invalid && complaintForm.get('priority')?.touched) {
            <mat-error>{{ 'Priority is required' | translate }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>{{ 'Assign to' | translate }}</mat-label>
          <mat-select formControlName="assignedTo">
            @for (a of assignedOptions; track a) {
              <mat-option [value]="a">{{ a | translate }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>{{ 'Update Message' | translate }}</mat-label>
        <textarea matInput formControlName="updateMessage"
                  placeholder="{{ 'Add an update message...' | translate }}"
                  rows="3"></textarea>
      </mat-form-field>

      <div class="button-group">
        <button mat-flat-button color="primary" (click)="saveChanges()">{{ 'Save changes' | translate }}</button>
        <button mat-stroked-button color="warn" (click)="discardChanges()">{{ 'Discard' | translate }}</button>
      </div>
    </form>

    @if (selectedImage) {
      <div class="image-modal" (click)="closeImage()">
        <img [src]="selectedImage" alt="{{ 'Large evidence' | translate }}" />
      </div>
    }
  }
</div>
