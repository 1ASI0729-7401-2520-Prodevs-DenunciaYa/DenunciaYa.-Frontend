<div class="container">
  <button class="back-button" mat-stroked-button color="accent" routerLink="/complaint-list">
    â† {{ 'Back to Complaints' | translate }}
  </button>

  <h2>{{ 'Edit Complaint' | translate }} #{{ complaintId }}</h2>

  <ng-container *ngIf="isLoading; else notLoading">
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>{{ 'Loading complaint data...' | translate }}</p>
    </div>
  </ng-container>

  <ng-template #notLoading>
    <ng-container *ngIf="errorMessage; else showForm">
      <div class="error">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ errorMessage }}</p>
        <button mat-button (click)="loadComplaintData()">{{ 'Retry' | translate }}</button>
      </div>
    </ng-container>
  </ng-template>

  <ng-template #showForm>
    <form [formGroup]="complaintForm" class="edit-form" (ngSubmit)="saveChanges()">
      <div class="row">
        <mat-form-field appearance="fill" class="readonly">
          <mat-label>{{ 'Category' | translate }}</mat-label>
          <input matInput formControlName="category" readonly />
        </mat-form-field>

        <mat-form-field appearance="fill" class="readonly">
          <mat-label>{{ 'Location' | translate }}</mat-label>
          <input matInput formControlName="location" readonly />
        </mat-form-field>
      </div>

      <mat-form-field appearance="fill" class="full-width readonly">
        <mat-label>{{ 'Reference' | translate }}</mat-label>
        <input matInput formControlName="referenceInfo" />
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width readonly">
        <mat-label>{{ 'Description' | translate }}</mat-label>
        <textarea matInput formControlName="description" readonly></textarea>
      </mat-form-field>

      <div class="evidence-section">
        <h3>{{ 'Evidence' | translate }}</h3>

        <ng-container *ngIf="complaintData?.evidence as evidence">
          <div *ngIf="evidence && evidence.length > 0; else noEvidence">
            <div class="evidence-gallery">
              <img *ngFor="let img of evidence; trackBy: trackByImage"
                   [src]="img"
                   alt="{{ 'Evidence' | translate }}"
                   class="evidence-img"
                   (click)="openImage(img)" />
            </div>
          </div>
          <ng-template #noEvidence>
            <p class="no-evidence">{{ 'No attached images' | translate }}</p>
          </ng-template>
        </ng-container>
      </div>

      <div class="row">
        <mat-form-field appearance="fill">
          <mat-label>{{ 'Status' | translate }}</mat-label>
          <mat-select formControlName="status" required>
            <mat-option *ngFor="let s of statuses" [value]="s">
              {{ s | translate }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="complaintForm.get('status')?.hasError('required') && complaintForm.get('status')?.touched">
            {{ 'Status is required' | translate }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>{{ 'Priority' | translate }}</mat-label>
          <mat-select formControlName="priority" required>
            <mat-option *ngFor="let p of priorities" [value]="p">
              {{ p | translate }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="complaintForm.get('priority')?.hasError('required') && complaintForm.get('priority')?.touched">
            {{ 'Priority is required' | translate }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>{{ 'Assign to' | translate }}</mat-label>
          <mat-select formControlName="assignedTo" required>
            <mat-option *ngFor="let a of assignedOptions" [value]="a">
              {{ a }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="complaintForm.get('assignedTo')?.hasError('required') && complaintForm.get('assignedTo')?.touched">
            {{ 'Assignee is required' | translate }}
          </mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>{{ 'Update Message' | translate }}</mat-label>
        <textarea matInput formControlName="updateMessage"
                  placeholder="{{ 'Add an update message...' | translate }}"
                  rows="3"></textarea>
      </mat-form-field>

      <div class="button-group">
        <button mat-flat-button color="primary" type="submit">{{ 'Save changes' | translate }}</button>
        <button mat-stroked-button color="warn" type="button" (click)="discardChanges()">{{ 'Discard' | translate }}</button>
      </div>
    </form>

    <div *ngIf="selectedImage" class="image-modal" (click)="closeImage()">
      <img [src]="selectedImage" alt="{{ 'Large evidence' | translate }}" />
    </div>
  </ng-template>
</div>
