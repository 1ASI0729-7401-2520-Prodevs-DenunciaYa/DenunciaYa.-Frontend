<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRrq_VcuuezEAhyUIBhkAV7iZOVqNDnqA"
  async
  defer
></script>

<div class="map-container" [attr.aria-label]="'MAP.CONTAINER_LABEL' | translate">

  <div *ngIf="loading" class="loading-overlay">
    <mat-progress-spinner diameter="50" mode="indeterminate"></mat-progress-spinner>
    <p class="loading-text">{{ 'MAP.LOADING.TEXT' | translate }}</p>
  </div>

  <mat-card class="header-card">
    <div class="header-content">
      <div>
        <h1 class="header-title">{{ 'MAP.HEADER.TITLE' | translate }}</h1>
        <p class="header-subtitle">{{ 'MAP.HEADER.SUBTITLE' | translate }}</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="loadComplaintsFromAPI()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          {{ loading ? ('MAP.LOADING.REFRESHING_BUTTON' | translate) : ('MAP.HEADER.ACTIONS.REFRESH' | translate) }}
        </button>
        <button mat-stroked-button color="warn" (click)="resetFilters()">
          <mat-icon>clear_all</mat-icon>
          {{ 'MAP.HEADER.ACTIONS.CLEAR_FILTERS' | translate }}
        </button>
      </div>
    </div>
  </mat-card>

  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>filter_list</mat-icon>
        {{ 'MAP.FILTERS.TITLE' | translate }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filters-grid">

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>{{ 'MAP.FILTERS.CATEGORY.LABEL' | translate }}</mat-label>
          <mat-select [(ngModel)]="selectedCategory" (ngModelChange)="filterComplaints()">
            <mat-option value="">{{ 'MAP.FILTERS.CATEGORY.ALL' | translate }}</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category">{{ category }}</mat-option>
          </mat-select>
          <button mat-icon-button matSuffix *ngIf="selectedCategory" (click)="$event.stopPropagation(); selectedCategory=''; filterComplaints()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>{{ 'MAP.FILTERS.DISTRICT.LABEL' | translate }}</mat-label>
          <mat-select [(ngModel)]="selectedDistrict" (ngModelChange)="filterComplaints()">
            <mat-option value="">{{ 'MAP.FILTERS.DISTRICT.ALL' | translate }}</mat-option>
            <mat-option *ngFor="let district of districts" [value]="district">{{ district }}</mat-option>
          </mat-select>
          <button mat-icon-button matSuffix *ngIf="selectedDistrict" (click)="$event.stopPropagation(); selectedDistrict=''; filterComplaints()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>{{ 'MAP.FILTERS.STATUS.LABEL' | translate }}</mat-label>
          <mat-select [(ngModel)]="selectedStatus" (ngModelChange)="filterComplaints()">
            <mat-option value="">{{ 'MAP.FILTERS.STATUS.ALL' | translate }}</mat-option>
            <mat-option *ngFor="let status of statuses" [value]="status">{{ status }}</mat-option>
          </mat-select>
          <button mat-icon-button matSuffix *ngIf="selectedStatus" (click)="$event.stopPropagation(); selectedStatus=''; filterComplaints()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="info-card">
    <div class="info-stats">
      <div class="stat-item">
        <mat-icon>place</mat-icon>
        <span class="stat-label">{{ 'MAP.STATS.VISIBLE_MARKERS' | translate }}</span>
        <span class="stat-value">{{ filteredMarkers.length }}</span>
      </div>
    </div>
  </mat-card>

  <mat-card class="map-card">
    <google-map
      height="500px"
      width="100%"
      [center]="center"
      [zoom]="zoom"
      [options]="{
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        styles: mapStyles
      }">

      <map-marker-clusterer>

        <map-marker
          *ngFor="let marker of filteredMarkers; trackBy: trackByMarkerId"
          [position]="marker.position"
          [title]="marker.title"
          [options]="{ icon: getMarkerIcon(marker.status) }">

          <map-info-window>
            <div class="info-window-content">
              <div class="info-header">
                <h3>{{ marker.complaintData.category }}</h3>
              </div>
            </div>
          </map-info-window>

        </map-marker>

      </map-marker-clusterer>

    </google-map>
  </mat-card>

  <mat-card class="legend-card">
    <mat-card-content>
      <div class="legend-items">
        <div class="legend-item"><div class="legend-color completed"></div><span>{{ 'MAP.LEGEND.ITEMS.COMPLETED' | translate }}</span></div>
        <div class="legend-item"><div class="legend-color pending"></div><span>{{ 'MAP.LEGEND.ITEMS.PENDING' | translate }}</span></div>
        <div class="legend-item"><div class="legend-color awaiting-response"></div><span>{{ 'MAP.LEGEND.ITEMS.AWAITING_RESPONSE' | translate }}</span></div>
        <div class="legend-item"><div class="legend-color rejected"></div><span>{{ 'MAP.LEGEND.ITEMS.REJECTED' | translate }}</span></div>
        <div class="legend-item"><div class="legend-color in-process"></div><span>{{ 'MAP.LEGEND.ITEMS.IN_PROCESS' | translate }}</span></div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
